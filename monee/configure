#!/bin/bash

name=monee
sim=tapas   # qemu bochs bochsm tapas tapas.q
#find source path
if [ -z "$source_path" ]; then
  source_path=`pwd`
else
  source_path=`cd $source_path; pwd`
fi

if [ $source_path == `pwd` ]; then
	#make build directory
  build_dir=`pwd`/../$name-build
	mkdir -p `pwd`/../debug
	config_host_mak="$source_path/config-host.mak"
	#make config-host.mak
	echo "# Automatically generated by configure - do not modify">$config_host_mak
	echo "# Configured with: $0 $@" >> $config_host_mak
	echo "NAME=$name" >> $config_host_mak
	echo "SRCDIR=$source_path" >> $config_host_mak
	echo "build=\$(abspath $build_dir)" >> $config_host_mak
	#make config-host.h
	config_host_h="$source_path/config-host.h"
	echo "// Automatically generated by configure - do not modify">$config_host_h
	echo "// Configured with: $0 $@" >> $config_host_h
	echo "#define HOST_I386 1" >> $config_host_h
else
  build_dir=`pwd`
fi
binutils_dist=binutils-2.19
binutils_dist_path=$source_path/tars/$binutils_dist.tar.bz2
mkdir -p $build_dir

rm -f $build_dir/Makefile

config_mak="$build_dir/config.mak"
config_h="$build_dir/config.h"
config_pm="$build_dir/config.pm"

echo "include $source_path/config-host.mak" > $config_mak
echo "TEST_VARIANTS_ALL=default tu1 numswap5 numtc10 record rr lockstep" \
				>>$config_mak
echo "TESTS_QUICKONLY=1" >> $config_mak

#Default test simulator
echo "TEST_SIMULATOR=$sim"	>> $config_mak
#Default test configure flags
echo "TEST_CONFIGURE_FLAGS=\"\""	>> $config_mak

echo "numswap5-test: TEST_CONFIGURE_FLAGS= max_num_swap_pages=5" >> $config_mak
echo "tu1-test: TEST_CONFIGURE_FLAGS= tu_size=1"	>> $config_mak
echo "record-test: TEST_SIMULATOR=$sim-record" >> $config_mak
echo "rr-test: TEST_SIMULATOR=$sim-rr" >> $config_mak
echo "lockstep-test: TEST_CONFIGURE_FLAGS=rec_print_freq=1000000">>$config_mak
echo "lockstep-test: TEST_SIMULATOR=$sim-lockstep" >> $config_mak
echo "BINUTILS_DIST=$binutils_dist" >> $config_mak
echo "BINUTILS_DIST_PATH=\$(abspath $binutils_dist_path)" >> $config_mak

echo "#include \"$source_path/config-host.h\"" > $config_h
echo "#define TARGET_I386" >> $config_h
if [ -z "$ndebug" ]; then
  /bin/true
else
  echo "#define NDEBUG" >> $config_h
fi
if [ -z "$tu_size" ]; then
  /bin/true
else
  echo "#define TU_SIZE $tu_size" >> $config_h
fi
if [ -z "$max_num_swap_pages" ]; then
  /bin/true
else
  echo "#define MAX_NUM_SWAP_PAGES $max_num_swap_pages" >> $config_h
fi
if [ -z "$max_num_tc_pages" ]; then
  /bin/true
else
  echo "#define MAX_NUM_TC_PAGES $max_num_tc_pages" >> $config_h
fi
if [ -z "$rec_print_freq" ]; then
	/bin/true
else
	echo "#define REC_PRINT_FREQ $rec_print_freq" >> $config_h
fi
